<html>
<head>
  <title>Localised JavaScript</title>
  <meta charset="utf-8">
  <style>
    textarea {
      display: block;
      width: 300px;
      height: 400px;
    }
    .ib {
      display: inline-block;
      vertical-align: top;
    }
  </style>
</head>
<body>
  <div>
    <div class="ib">
      From <select id="locale">
        <option>fi-FI</option>
        <option>en-US</option>
        <option>Custom</option>
      </select>
      <textarea id="source">
funktio f(x) {
  jos (x % 2 == 0) {
    palauta tosi;
  } muuten {
    palauta epätosi;
  }
}

joka (muu i = 0; i < 10; i++) {
  console.log(i, f(i));
  jos (i > 5) lopeta;
}

muu Terve = funktio(nimi) {
  tämä.nimi = nimi;
};
Terve.prototyyppi = {};
Terve.prototyyppi.moi = funktio() {
  console.log( "Moi, " + tämä.nimi + "!" );
};

muu tere = uusi Terve("Veijo");

tere.moi();

joka (muu i johon tere) {
  console.log(i);
}
      </textarea>
    </div>
    <div class="ib">
      To <select id="targetLocale">
        <option>ja-JP</option>
        <option>en-US</option>
        <option>fi-FI</option>
        <option>Custom</option>
      </select>
      <textarea id="javascript" disabled="disabled">Translation output</textarea>
    </div>
  </div>
  <button id="run">Run</button>
  <div>
    <h3>Make your custom translation</h3>
    <div id="customLocale">
    </div>
  </div>
  <script src="esprima.js"></script>
  <script>
var invert = function(obj) {
  var o = {};
  for (var i in obj) {
    o[obj[i]] = i;
  }
  return o;
};
    window.LocaleMappings = {
	'en-US': {
	    'if': 'if',
	    'in': 'in',
	    'do': 'do',
	    
	    'var': 'var',
	    'for': 'for',
	    'new': 'new',
	    'try': 'try',
	    
	    'this': 'this',
	    'else': 'else',
	    'case': 'case',
	    'void': 'void',
	    'with': 'with',
	    
	    'while': 'while',
	    'break': 'break',
	    'catch': 'catch',
	    'throw': 'throw',
	    
	    'return': 'return',
	    'typeof': 'typeof',
	    'delete': 'delete',
	    'switch': 'switch',
	    
	    'default': 'default',
	    'finally': 'finally',
	    'function': 'function',
	    'continue': 'continue',
	    'debugger': 'debugger',

	    'instanceof': 'instanceof',

	    'true': 'true',
	    'false': 'false',
	    'null': 'null',
	    'undefined': 'undefined',
	    'prototype': 'prototype',

	    'yield': 'yield',
	    'let': 'let',

	    'class': 'class',
	    'enum': 'enum',
	    'export': 'export',
	    'extends': 'extends',
	    'import': 'import',
	    'super': 'super',

	    'implements': 'implements',
	    'interface': 'interface',
	    'package': 'package',
	    'private': 'private',
	    'protected': 'protected',
	    'public': 'public',
	    'static': 'static'
	},

'ja-JP': invert({
    'function':'関数',
    'if':'もし',
    'else':'それ以外',
    'for':'なら',
    'while':'ながら',
    'return':'戻す',
    'do':'する',
    'true':'真',
    'false':'偽',
    'var':'変数',
    'in':'が',
    'let':'させ',
    'new':'新',
    'try':'試',
    'case':'ケース',
    'null':'ヌル',
    'this':'これ',
    'with':'と',
    'break':'中断',
    'throw':'投げ',
    'catch':'受け',
    'switch':'スイッチ',
    'continue':'続け',
    'debugger':'デバッガ',
    'instanceof':'実例',
    'typeof':'属性',
    'void':'無効',
    'delete':'削除',
    'default':'デフォルト',
    'finally':'やっと'
}),

	'fi-FI': {
             'jos':'if',
             'johon':'in',
             'tee':'do',

             'muu':'var',
             'joka':'for',
             'uusi':'new',
             'yritä':'try',

             'tämä':'this',
             'muuten':'else',
             'tapaus':'case',
             'tyhjiö':'void',
             'jolle':'with',

             'kun':'while',
             'lopeta':'break',
             'koppi':'catch',
             'heitä':'throw',

             'palauta':'return',
             'tyyppi':'typeof',
             'poista':'delete',
             'valitse':'switch',

             'oletus':'default',
             'viimein':'finally',
             'funktio':'function',
             'jatka':'continue',
             'debuggeri':'debugger',

             'instanssi':'instanceof',

             'tosi':'true',
             'epätosi':'false',
             'tyhjä':'null',
             'puuttuva':'undefined',
             'prototyyppi':'prototype',

             'anna':'yield',
             'on':'let',

             'luokka':'class',
             'num':'enum',
             'vie':'export',
             'laajentaa':'extends',
             'tuo':'import',
             'yli':'super',

             'toteuttaa':'implements',
             'rajapinta':'interface',
             'pakkaus':'package',
             'yksityinen':'private',
             'suojattu':'protected',
             'julkinen':'public',
             'staattinen':'static'
	}
    };

var prettyPrint = function(tokens, locale) {
    var strings = [];
    var indent = "";
    var loc, iloc;
    if (locale) {
      loc = LocaleMappings[locale];
      iloc = {};
      for (var i in loc) {
        iloc[loc[i]] = i;
      }
    }
    var idx = 0;
    var writeOut = function (token) {
        var string = null;
        switch (token.type) {
            case 'Boolean':
            case 'Identifier':
            case 'Keyword':
            case 'Null':
            case 'Numeric':
            case 'Punctuator':
                string = token.id;
                var id = LocaleMappings['en-US'][token.id];
                if (id !== undefined) {
                  if (locale) {
                    string = token.value.replace(/\S+/, iloc[token.id]);
                  } else {
                    string = token.value.replace(/\S+/, id);
                  }
                }
                break;
            case 'WhiteSpace':
            case 'RegularExpression':
            case 'String':
                string = token.value;
                break;
            case 'BlockComment':
                string = '/*' + token.value + '*/';
                break;
            case 'LineComment':
                string = '//' + token.value + '\n';
                break;
        }

        return string;
    };

    return tokens.map(writeOut).join('');
};

var injectWhiteSpace = function(src, tokens) {
  var i = 0;
  var tok = tokens[i];
  if (!tok) {
    tokens.push({"type":"WhiteSpace", "value":src, range:[0,src.length-1]});
  } else {
    var start = 0;
    var end = tokens[i].range[0]-1;
    if (end-start >= 0) {
      tokens.splice(i, 0, {type:"WhiteSpace", value:src.substring(start, end+1), range:[start, end]});
      i++;
    }
    i++;
    for (; i < tokens.length; i++) {
      start = tokens[i-1].range[1]+1;
      end = tokens[i].range[0]-1;
      if (end-start >= 0) {
        tokens.splice(i, 0, {type:"WhiteSpace", value:src.substring(start, end+1), range:[start, end]});
        i++;
      }
    }
  }
};


var delocalise = function(src, locale) {
    LOCALE = locale;
    var ast = esprima.parse(src, {
        comment: true,
        range: true,
        tokens: true
    });
    injectWhiteSpace(src, ast.tokens);
    var tsrc = prettyPrint(ast.tokens);
    return tsrc;
};

var localise = function(src, locale) {
    LOCALE = 'en-US';
    var ast = esprima.parse(src, {
        comment: true,
        range: true,
        tokens: true
    });
    injectWhiteSpace(src, ast.tokens);
    var tsrc = prettyPrint(ast.tokens, locale);
    return tsrc;
};


var c = document.getElementById('customLocale');
var loc = LocaleMappings['fi-FI']; 
var cloc = LocaleMappings['Custom'] = {};
for (var i in loc) {
  cloc[i] = loc[i];
  var locInput = document.createElement('div');
  var inp = document.createElement('input');
  inp.value = i;
  inp.onchange = (function(translation) {
    return function() {
      cloc[this.value] = translation;
    };
  })(loc[i]);
  locInput.appendChild(inp);
  locInput.appendChild(document.createTextNode(" -> " + loc[i]));
  c.appendChild(locInput);
}

document.getElementById('run').onclick = function() {
  var src = document.getElementById('source').value;
  var locale = document.getElementById('locale').value;
  var targetLocale = document.getElementById('targetLocale').value;
  var js;
  try {
    if (locale === 'en-US') {
      js = src;
    } else {
      js = delocalise(src, locale);
    }
    document.getElementById('javascript').value = localise(js, targetLocale);
  } catch(e) {
    document.getElementById('javascript').value = "Parse error: " + e;
  }
  if (js) eval(js);
};

</script>
</body>
</html>
